{% extends 'base.html' %}

{% block title %}{{ product.name }} - Yarned with Love{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'product_list' %}"
                    class="text-decoration-none text-muted">Home</a></li>
            {% if product.category %}
            <li class="breadcrumb-item">
                <a href="{% url 'product_list' %}?category={{ product.category.slug }}"
                    class="text-decoration-none text-muted">{{ product.category.name }}</a>
            </li>
            {% endif %}
            <li class="breadcrumb-item active" aria-current="page" style="color: var(--primary-color);"
                data-fill="product-name">{{ product.name }}</li>
        </ol>
    </nav>

    <div class="row gx-5">
        <!-- Left Column: Image -->
        <div class="col-lg-6 mb-5 mb-lg-0">
            <!-- Image Gallery (Carousel) -->
            <div id="productCarousel" class="carousel slide rounded-4 overflow-hidden shadow-lg stitched-border"
                data-bs-ride="carousel">
                <div class="carousel-inner">
                    <!-- Main Image (First) -->
                    <div class="carousel-item active">
                        {% if product.image %}
                        <img src="{{ product.image.url }}" class="d-block w-100"
                            style="object-fit: contain; max-height: 80vh;" alt="{{ product.name }}">
                        <!-- Decorative Yarn Overlay -->
                        <div class="position-absolute top-0 end-0 m-3 px-3 py-1 rounded-pill shadow-sm"
                            style="background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(2px); border: 2px solid #ffe4ec;">
                            <small class="fw-bold" style="color: var(--primary-color);">Handmade with Love üß∂</small>
                        </div>
                        {% else %}
                        <div class="d-flex align-items-center justify-content-center bg-light" style="height: 500px;">
                            <span class="text-muted display-6">üß∂ Image Coming Soon</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Extra Images -->
                    {% for img in product.images.all %}
                    <div class="carousel-item">
                        <img src="{{ img.image.url }}" class="d-block w-100"
                            style="object-fit: contain; max-height: 80vh;" alt="Detail for {{ product.name }}">
                        <div class="position-absolute top-0 end-0 m-3 px-2 py-1 rounded-pill shadow-sm"
                            style="background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(2px);">
                            <small class="fw-bold" style="color: var(--primary-color);">Handmade üß∂</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {% if product.images.all %}
                <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel"
                    data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"
                        style="background-color: rgba(0,0,0,0.3); border-radius: 50%;"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#productCarousel"
                    data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"
                        style="background-color: rgba(0,0,0,0.3); border-radius: 50%;"></span>
                    <span class="visually-hidden">Next</span>
                </button>
                {% endif %}

                {% if is_new %}
                <span class="position-absolute top-0 start-0 m-3 badge bg-primary shadow-sm"
                    style="z-index: 20; font-size: 0.8rem;">
                    Recently Added
                </span>
                {% endif %}

                {% if product.artisan.vacation_mode %}
                <div class="position-absolute bottom-0 start-0 w-100 text-center py-2"
                    style="background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(4px); border-top: 1px solid rgba(0,0,0,0.1); z-index: 20;">
                    <span class="fw-bold text-danger">üèñÔ∏è Artist on Vacation</span>
                </div>
                {% endif %}
            </div>

            <!-- Thumbnails (Optional, simple grid) -->
            {% if product.images.all %}
            <div class="row g-2 mt-2">
                <div class="col-3">
                    <img src="{{ product.image.url }}" class="img-thumbnail w-100 cursor-pointer"
                        style="height: 80px; object-fit: cover; opacity: 1;"
                        onclick="var c = new bootstrap.Carousel(document.getElementById('productCarousel')); c.to(0);">
                </div>
                {% for img in product.images.all %}
                <div class="col-3">
                    <img src="{{ img.image.url }}" class="img-thumbnail w-100 cursor-pointer"
                        style="height: 80px; object-fit: cover; opacity: 0.7;" onmouseover="this.style.opacity=1"
                        onmouseout="this.style.opacity=0.7"
                        onclick="var c = new bootstrap.Carousel(document.getElementById('productCarousel')); c.to({{ forloop.counter }});">
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Specifications (Desktop) -->
            <div class="d-none d-lg-block mt-5">
                <h5 class="fw-bold mb-3" style="color: var(--text-dark);">Specifications</h5>
                <div class="d-flex flex-wrap gap-2">
                    {% if product.specifications %}
                    {% for spec in product.specifications.splitlines %}
                    <span class="badge bg-light text-dark border">{{ spec }}</span>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">No specific specs.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column: Details -->
        <div class="col-lg-6">
            <span class="badge mb-2" style="background-color: #ffe4ec; color: var(--primary-color);"
                data-fill="product-category">{{ product.category.name|default:"General" }}</span>
            <h1 class="display-4 fw-bold mb-2">{{ product.name }}</h1>

            <!-- Color Variants Section -->


            <!-- Quality Promise -->
            <div class="quality-promise-card my-4">
                <div class="quality-icon">üß∂</div>
                <div>
                    <h6 class="fw-bold mb-1" style="color: var(--text-dark);">Premium Quality Yarn</h6>

                    <script>
                        (function () {
                            const name = "{{ product.name|escapejs }}";
                            const category = "{{ product.category.name|default:'General'|escapejs }}";
                            document.querySelectorAll('[data-fill="product-name"]').forEach(el => el.textContent = name);
                            document.querySelectorAll('[data-fill="product-category"]').forEach(el => el.textContent = category);
                        })();
                    </script>
                    <p class="small text-muted mb-0">Handcrafted with high-grade, skin-friendly threads only.</p>
                </div>
            </div>

            <div class="d-flex align-items-baseline gap-3 mb-4">
                <h2 class="h1 fw-bold" style="color: var(--primary-color);">{% if product.id == 31 or "santa" in
                    product.name|lower %}‚Çπ70.00{% else %}‚Çπ{{ product.price }}{% endif %}</h2>
                {% if product.mrp %}
                <span class="text-decoration-line-through text-muted fs-5">MRP ‚Çπ{{ product.mrp }}</span>
                <span class="text-success fw-bold small">Inclusive of all taxes</span>
                {% endif %}
            </div>

            {% if product.short_description %}
            <p class="lead text-muted mb-4">{{ product.short_description }}</p>
            {% endif %}

            <!-- Action Buttons -->
            <style>
                /* Mobile Sticky Action Bar */
                @media (max-width: 768px) {
                    .mobile-sticky-actions {
                        position: fixed !important;
                        bottom: 0;
                        left: 0;
                        right: 0;
                        background: rgba(255, 255, 255, 0.95);
                        backdrop-filter: blur(10px);
                        padding: 15px;
                        z-index: 1000;
                        box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
                        border-top: 1px solid rgba(0, 0, 0, 0.05);
                        margin-bottom: 0 !important;
                        display: flex !important;
                        gap: 10px;
                        align-items: center;
                        justify-content: space-between;
                    }

                    /* Fix button sizes in sticky bar */
                    .mobile-sticky-actions .btn {
                        flex: 1;
                        border-radius: 50px;
                        /* Pill shape looks better */
                        padding: 10px 0;
                        font-size: 1rem;
                    }

                    .mobile-sticky-actions label,
                    .mobile-sticky-actions input {
                        display: none;
                        /* Hide quantity on sticky bar to save space, default to 1 */
                    }

                    /* Adjust image height for mobile */
                    .carousel-item img {
                        max-height: 50vh !important;
                    }
                }
            </style>

            {% if user.is_artisan %}
            <div class="alert alert-info">
                <strong>Artisan View:</strong> You are viewing this product as an artisan. Ordering is disabled.
            </div>
            {% elif product.artisan.vacation_mode %}
            <div class="alert alert-warning border-0 shadow-sm rounded-3">
                <h5 class="fw-bold"><span class="fs-2 me-2">üèñÔ∏è</span>Artist is on Vacation</h5>
                <p class="mb-0">You can add this active to your cart, but shipping may be delayed until the artist
                    returns.</p>
            </div>
            <form action="{% url 'add_to_cart' product.pk %}" method="POST"
                class="d-grid gap-2 d-md-flex align-items-end opacity-75 mobile-sticky-actions">
                {% csrf_token %}
                <div style="max-width: 100px;">
                    <label class="form-label small fw-bold">Quantity</label>
                    <input type="number" name="quantity" value="1" min="1"
                        class="form-control rounded-3 border-secondary">
                </div>
                <button type="submit" name="action" value="add_to_cart" class="btn btn-main btn-lg px-4 flex-grow-1">üõí
                    Add to Cart</button>
                <button type="submit" name="action" value="buy_now" class="btn btn-dark btn-lg px-4 flex-grow-1">‚ö° Buy
                    Now</button>
            </form>
            {% else %}
            <form action="{% url 'add_to_cart' product.pk %}" method="POST"
                class="d-grid gap-2 d-md-flex align-items-end mobile-sticky-actions">
                {% csrf_token %}
                <div style="max-width: 100px;">
                    <label class="form-label small fw-bold">Quantity</label>
                    <input type="number" name="quantity" value="1" min="1"
                        class="form-control rounded-3 border-secondary">
                </div>
                <button type="submit" name="action" value="add_to_cart" class="btn btn-main btn-lg px-4 flex-grow-1">üõí
                    Add to Cart</button>
                <button type="submit" name="action" value="buy_now" class="btn btn-dark btn-lg px-4 flex-grow-1">‚ö° Buy
                    Now</button>
            </form>
            <!-- Mobile Spacer to prevent content from being hidden behind sticky bar -->
            <div class="d-block d-md-none" style="height: 100px;"></div>
            {% endif %}
        </div>

        <!-- Key Features -->
        {% if product.key_features %}
        <div class="mb-5">
            <h5 class="fw-bold mb-3" style="color: var(--text-dark);">Key Features:</h5>
            <ul class="list-unstyled">
                {% for feature in product.key_features.splitlines %}
                <li class="mb-2 d-flex align-items-start">
                    <span class="me-2" style="color: var(--primary-color);">‚úî</span>
                    {{ feature }}
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Care Instructions -->
        {% if product.care_instructions %}
        <div class="mb-5">
            <h5 class="fw-bold mb-3" style="color: var(--text-dark);">Care Instructions:</h5>
            <ul class="list-unstyled">
                {% for instruction in product.care_instructions.splitlines %}
                <li class="mb-2 d-flex align-items-start">
                    <span class="me-2" style="color: var(--primary-color);">üßµ</span>
                    {{ instruction }}
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Why Choose Us -->
        <div class="bg-light p-4 rounded-3 border">
            <h5 class="fw-bold mb-2">Why Choose Us?</h5>
            <p class="text-muted small mb-0">
                At Yarned with Love, we prioritize quality and craftsmanship in every item we create.
                Our creations are a testament to our dedication to providing handmade products that inspire
                happiness. üíù
            </p>
        </div>

        <!-- Metadata -->
        <div class="mt-4 pt-3 border-top d-flex justify-content-between text-muted small">
            <span>SKU: YWL-{{ product.id }}</span>
            <span>Creation Time: {{ product.estimated_days_to_complete }} Days</span>
            <span>Returns: {% if product.is_returnable %}Accepted{% else %}Not Returnable{% endif %}</span>
        </div>
        <p class="text-danger small mt-2 mb-0"><i class="bi bi-info-circle"></i> Note: Order delivery date is
            subject to total availability and artisan schedule.</p>
    </div>
</div>

<!-- Reviews Section -->
<div class="mt-5 pt-5 border-top" id="reviews">
    <h3 class="fw-bold mb-4" style="color: var(--text-dark);">Customer Reviews üåü</h3>

    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="bg-light p-4 rounded-4 text-center">
                <h1 class="display-3 fw-bold text-warning">{{ avg_rating|floatformat:1 }}</h1>
                <div class="text-warning mb-2 fs-4">
                    {% if avg_rating >= 1 %}‚òÖ{% else %}‚òÜ{% endif %}
                    {% if avg_rating >= 2 %}‚òÖ{% else %}‚òÜ{% endif %}
                    {% if avg_rating >= 3 %}‚òÖ{% else %}‚òÜ{% endif %}
                    {% if avg_rating >= 4 %}‚òÖ{% else %}‚òÜ{% endif %}
                    {% if avg_rating >= 5 %}‚òÖ{% else %}‚òÜ{% endif %}
                </div>
                <p class="text-muted">{{ reviews|length }} Review{% if reviews|length != 1 %}s{% endif %}</p>
            </div>
        </div>

        <div class="col-md-8">
            <!-- Add Review Form (Restricted for Default Artisan) -->
            {% if user.is_authenticated %}
            {% if product.artisan.username != 'thepranit' and product.artisan.username != 'artisan_demo' %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">Write a Review</h5>
                    <form action="{% url 'add_review' product.pk %}" method="POST">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label small text-muted">Rating</label>
                            <div class="rating-input d-flex gap-2">
                                {% for i in "54321" %}
                                <input type="radio" class="btn-check" name="rating" id="rating{{i}}" value="{{i}}"
                                    required>
                                <label class="btn btn-outline-warning" for="rating{{i}}">{{i}}‚òÖ</label>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">Comment</label>
                            <textarea name="comment" class="form-control" rows="3" placeholder="How did you like it?"
                                required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary rounded-pill px-4">Post Review</button>
                    </form>
                </div>
            </div>
            {% endif %}
            {% endif %}

            <!-- Existing Reviews -->
            <div class="review-list">
                {% for review in reviews %}
                <div class="card border-0 mb-3 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <h6 class="fw-bold mb-0 d-flex align-items-center">
                                {% if review.customer_photo %}
                                <img src="{{ review.customer_photo.url }}" class="rounded-circle me-2"
                                    style="width: 30px; height: 30px; object-fit: cover;">
                                {% endif %}
                                <span class="me-2">{{ review.customer_name|default:review.customer.get_display_name
                                    }}</span>
                                {% if review.customer == user and not review.customer_name %}<span
                                    class="badge bg-light text-dark">You</span>{% endif %}
                            </h6>
                            <small class="text-muted">{{ review.created_at|timesince }} ago</small>
                        </div>
                        <div class="text-warning mb-2 small">
                            {% for i in "12345"|make_list %}
                            {% if forloop.counter <= review.rating %}‚òÖ{% else %}‚òÜ{% endif %} {% endfor %} </div>
                                <p class="mb-0 text-muted">{{ review.comment }}</p>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No reviews yet. Be the first to share your thoughts!</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Related Products -->
    {% if related_products %}
    <div class="mt-5 pt-5 border-top">
        <h3 class="fw-bold mb-4" style="color: var(--text-dark);">Suggestions from same category üíñ</h3>
        <div class="row g-4">
            {% for related in related_products %}
            <div class="col-6 col-md-3">
                <a href="{% url 'product_detail' related.pk %}" class="text-decoration-none">
                    <div class="card h-100 border-0 shadow-sm feature-card">
                        <div class="position-relative"
                            style="padding-top: 100%; background: #f8f8f8; border-radius: 15px; overflow: hidden;">
                            {% if related.image %}
                            <img src="{{ related.image.url }}" class="position-absolute top-0 start-0 w-100 h-100"
                                style="object-fit: cover;" alt="{{ related.name }}">
                            {% else %}
                            <div
                                class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center text-muted">
                                üß∂
                            </div>
                            {% endif %}
                        </div>
                        <div class="card-body px-0 text-center">
                            <h6 class="fw-bold mb-1 text-dark">{{ related.name }}</h6>
                            <p class="text-muted small mb-0">{% if related.id == 31 or "santa" in related.name|lower
                                %}‚Çπ70.00{% else %}‚Çπ{{ related.price }}{% endif %}</p>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}